<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BudgetMaster Pro</title>
    <!-- PWA Settings -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6366F1">
    <link rel="icon" type="image/png" href="icon.png">

    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW Registered!', reg))
                    .catch(err => console.log('SW Failed:', err));
            });
        }
    </script>
    <style>
        :root {
            --primary: #4F46E5;
            --primary-dark: #4338ca;
            --bg: #F3F4F6;
            --card-bg: #FFFFFF;
            --text-main: #1F2937;
            --text-sub: #6B7280;
            --success: #10B981;
            --danger: #EF4444;
            --warning: #F59E0B;
            --input-bg: #FFFFFF;
            --input-border: #E5E7EB;
        }

        [data-theme="dark"] {
            --bg: #111827;
            --card-bg: #1F2937;
            --text-main: #F9FAFB;
            --text-sub: #9CA3AF;
            --input-bg: #374151;
            --input-border: #4B5563;
        }

        * {
            box-sizing: border-box;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Rubik', sans-serif;
            background: var(--bg);
            color: var(--text-main);
            direction: rtl;
            margin: 0;
            padding: 0;
        }

        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            padding-bottom: 80px;
        }

        /* Typography */
        h1,
        h2,
        h3 {
            margin: 0;
            font-weight: 700;
            margin: 0;
            font-weight: 700;
            color: var(--text-main);
        }

        h2 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        h3 {
            font-size: 18px;
            margin-bottom: 15px;
        }

        /* Auth Screen */
        #authScreen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #4F46E5, #818CF8);
        }

        .auth-card {
            background: var(--card-bg);
            padding: 40px;
            border-radius: 24px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .auth-card h2 {
            color: var(--primary);
            margin-bottom: 30px;
            font-size: 28px;
        }

        /* Main App Structure */
        #mainApp {
            display: none;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            background: #E0E7FF;
            color: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
        }

        /* Controls */
        .controls-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            overflow-x: auto;
            padding-bottom: 5px;
            align-items: center;
        }

        .icon-btn {
            background: var(--card-bg);
            border: 1px solid var(--input-border);
            color: var(--text-main);
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            transition: 0.2s;
        }

        .icon-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .date-picker {
            padding: 10px 16px;
            border: 1px solid #E5E7EB;
            border-radius: 12px;
            font-family: 'Rubik';
            background: var(--input-bg);
            color: var(--text-main);
            cursor: pointer;
        }

        .add-cat-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 12px;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: 0.2s;
        }

        .add-cat-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        /* Grid Layout */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 340px;
            gap: 25px;
        }

        @media (max-width: 900px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            border: 1px solid #F3F4F6;
        }

        /* Category List */
        .cat-list {
            display: grid;
            gap: 16px;
        }

        .cat-item {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid #E5E7EB;
            transition: 0.2s;
            position: relative;
            overflow: hidden;
        }

        .cat-item:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .cat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            cursor: pointer;
        }

        .cat-name {
            font-weight: 600;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .cat-stats {
            font-size: 14px;
            color: var(--text-sub);
        }

        .cat-stats b {
            color: var(--text-main) !important;
        }

        .progress-bg {
            background: #F3F4F6;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .cat-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            border-top: 1px solid #f3f4f6;
            padding-top: 12px;
        }

        .action-chip {
            font-size: 12px;
            padding: 6px 12px;
            background: #F9FAFB;
            border-radius: 20px;
            color: var(--text-sub);
            cursor: pointer;
            border: 1px solid #E5E7EB;
            transition: 0.2s;
        }

        .action-chip:hover {
            background: #EEF2FF;
            color: var(--primary);
            border-color: #C7D2FE;
        }

        /* History List */
        .history-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 0;
            border-bottom: 1px solid #F3F4F6;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .tx-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .tx-note {
            font-weight: 500;
            font-size: 15px;
        }

        .tx-meta {
            font-size: 12px;
            color: var(--text-sub);
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .tx-amount {
            font-weight: 600;
            color: var(--danger);
            font-size: 16px;
        }

        .tx-actions button {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            opacity: 0.5;
            transition: 0.2s;
            padding: 4px;
        }

        .tx-actions button:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        /* Forms */
        input,
        select {
            width: 100%;
            padding: 14px;
            margin: 8px 0;
            border: 1px solid #E5E7EB;
            border-radius: 12px;
            font-size: 16px;
            font-family: 'Rubik';
            transition: 0.2s;
        }

        input:focus,
        select:focus {
            border-color: var(--primary);
            outline: none;
            ring: 2px solid #E0E7FF;
        }

        .btn-main {
            width: 100%;
            padding: 16px;
            border-radius: 14px;
            border: none;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            background: var(--primary);
            color: white;
            margin-top: 15px;
            transition: 0.2s;
            font-family: 'Rubik';
        }

        .btn-main:hover {
            background: var(--primary-dark);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            align-items: flex-end;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        @media (min-width: 600px) {
            .modal {
                align-items: center;
            }
        }

        .modal-content {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 24px 24px 0 0;
            width: 100%;
            max-width: 500px;
            animation: slideUp 0.3s ease;
        }

        @media (min-width: 600px) {
            .modal-content {
                border-radius: 24px;
                animation: fadeIn 0.3s ease;
            }

            .modal-content {
                border-radius: 24px;
                animation: fadeIn 0.3s ease;
            }
        }

        /* Toaster */
        .toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
            width: 90%;
            max-width: 400px;
        }

        .toast {
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideDown 0.3s ease;
            pointer-events: auto;
            direction: rtl;
        }

        .toast.success {
            background: var(--success);
        }

        .toast.error {
            background: var(--danger);
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes fadeOutToast {
            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }

            to {
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Summary Chips */
        .summary-chips {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .sum-chip {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 16px;
            flex: 1;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.03);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .sum-val {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
        }

        .sum-lbl {
            font-size: 12px;
            color: var(--text-sub);
        }

        /* Bottom Nav */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border-top: 1px solid var(--input-border);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            padding-bottom: max(10px, env(safe-area-inset-bottom));
            z-index: 900;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            font-size: 10px;
            color: var(--text-sub);
            border: none;
            background: none;
            cursor: pointer;
            width: 100%;
        }

        .nav-item span {
            font-size: 20px;
        }

        .nav-item.active {
            color: var(--primary);
        }

        .view-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .view-section.active {
            display: block;
        }
    </style>
</head>

<body>

    <div class="toast-container" id="toastContainer"></div>

    <!-- Login Screen -->
    <div id="authScreen">
        <div class="auth-card">
            <h2>BudgetMaster Pro <span style="font-size:12px; opacity:0.5;">v20</span></h2>
            <p style="color:var(--text-sub); margin-bottom: 20px;">× ×™×”×•×œ ×ª×§×¦×™×‘ ×—×›× ×•×¤×©×•×˜</p>
            <input type="email" id="email" placeholder="×›×ª×•×‘×ª ××™××™×™×œ">
            <input type="password" id="password" placeholder="×¡×™×¡××”">
            <button class="btn-main" id="loginBtn">×”×ª×—×‘×¨×•×ª</button>
            <button class="btn-main" style="background: #F3F4F6; color: var(--text-main); margin-top: 10px;"
                id="signupBtn">×”×¨×©××” ×œ×—×“×©×™×</button>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="mainApp">
        <div class="app-container">

            <div class="header">
                <div class="user-info">
                    <div class="avatar" id="avatarLetter">?</div>
                    <div>
                        <div style="font-size:12px; color:var(--text-sub);">×©×œ×•× ×œ×©×•×‘×š,</div>
                        <div style="font-weight:700;" id="userEmailDisplay">××©×ª××©</div>
                    </div>
                </div>
                <div style="display:flex; gap:10px;">
                    <button onclick="toggleTheme()" class="icon-btn" title="××¦×‘ ×œ×™×œ×”/×™×•×">ğŸŒ“</button>
                    <button onclick="logout()"
                        style="border:none; background:#FEE2E2; color:var(--danger); padding: 8px 16px; border-radius:10px; cursor:pointer; font-weight:600; font-family:'Rubik';">×™×¦×™××”</button>
                </div>
            </div>

            <div class="controls-bar">
                <input type="month" id="monthPicker" class="date-picker">
                <button onclick="openAddCat()" class="add-cat-btn">
                    <span>+</span> ×§×˜×’×•×¨×™×” ×—×“×©×”
                </button>
                <button onclick="exportToCSV()" class="icon-btn" title="×™×™×¦×•× ×œ××§×¡×œ"
                    style="width:auto; padding:0 15px; font-size:14px; gap:8px;">
                    ğŸ“¥ ×™×™×¦×•× CSV
                </button>
                <button onclick="openRecurring()" class="icon-btn" title="×”×•×¦××•×ª ×§×‘×•×¢×•×ª"
                    style="width:auto; padding:0 15px; font-size:14px; gap:8px;">
                    ğŸ”„ ×”×•×¨××•×ª ×§×‘×¢
                </button>
            </div>

            <!-- TAB 1: HOME -->
            <div id="view-home" class="view-section active">
                <div class="summary-chips">
                    <div class="sum-chip">
                        <span class="sum-val" id="totalBudgetDisplay">â‚ª0</span>
                        <span class="sum-lbl">×ª×§×¦×™×‘ ×›×•×œ×œ</span>
                    </div>
                    <div class="sum-chip">
                        <span class="sum-val" id="totalSpentDisplay" style="color:var(--danger)">â‚ª0</span>
                        <span class="sum-lbl">×”×•×¦××•×ª</span>
                    </div>
                    <div class="sum-chip">
                        <span class="sum-val" id="balanceDisplay" style="color:var(--success)">â‚ª0</span>
                        <span class="sum-lbl">×™×ª×¨×”</span>
                    </div>
                </div>

                <h3 style="margin-bottom:15px; color:var(--text-sub);">×”×•×¦××•×ª ×œ×¤×™ ×§×˜×’×•×¨×™×•×ª</h3>
                <div id="catList" class="cat-list"></div>
            </div>

            <!-- TAB 2: ACTIVITY (History + Search) -->
            <div id="view-activity" class="view-section">
                <!-- Search Bar -->
                <div style="margin-bottom:15px;">
                    <input type="text" id="searchInput" placeholder="ğŸ” ×—×™×¤×•×© ×”×•×¦××”..." onkeyup="render()">
                </div>
                <div class="card">
                    <h3>×¤×¢×•×œ×•×ª ××—×¨×•× ×•×ª</h3>
                    <div id="historyList" class="history-list"></div>
                </div>
            </div>

            <!-- TAB 3: INSIGHTS (Charts + Income) -->
            <div id="view-insights" class="view-section">
                <!-- Income Section -->
                <div class="card" style="margin-bottom:20px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h3>ğŸ’° ×”×›× ×¡×•×ª</h3>
                        <div style="text-align:left;">
                            <span style="font-size:12px; color:var(--text-sub);">×¡×”"×› ×”×›× ×¡×•×ª</span>
                            <div style="font-weight:700; color:var(--success); font-size:18px;" id="totalIncomeDisplay">
                                â‚ª0</div>
                        </div>
                    </div>
                    <button class="btn-main" onclick="openAddIncome()"
                        style="margin-top:0; background:#ECFDF5; color:var(--success); border:1px solid #10B981;">+
                        ×”×•×¡×¤×ª ×”×›× ×¡×”</button>
                    <div id="incomeList" style="margin-top:15px; display:flex; flex-direction:column; gap:10px;"></div>
                </div>

                <!-- Analytics Section -->
                <div class="card">
                    <h3>ğŸ“Š ×”×›× ×¡×•×ª ××•×œ ×”×•×¦××•×ª</h3>
                    <div style="height:250px; position:relative;">
                        <canvas id="barChart"></canvas>
                    </div>
                </div>

                <div class="card" style="margin-top:20px;">
                    <h3>ğŸ° ×”×ª×¤×œ×’×•×ª ×”×•×¦××•×ª</h3>
                    <div style="height:250px; position:relative;">
                        <canvas id="pieChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- TAB 4: ASSETS (Savings + Gifts) -->
            <div id="view-assets" class="view-section">
                <div class="dashboard-grid">
                    <div class="card">
                        <div
                            style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                            <h3>ğŸ¯ ×™×¢×“×™ ×—×™×¡×›×•×Ÿ</h3>
                            <button onclick="addSavingsGoal()"
                                style="background:var(--success); color:white; border:none; width:30px; height:30px; border-radius:50%; font-size:18px; cursor:pointer;">+</button>
                        </div>
                        <div id="savingsList" style="display:flex; flex-direction:column; gap:15px;"></div>
                    </div>

                    <div class="card">
                        <div
                            style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                            <h3>ğŸ ×”××¨× ×§ ×©×œ×™ (Gift Cards)</h3>
                            <button onclick="addGiftCard()"
                                style="background:var(--primary); color:white; border:none; width:30px; height:30px; border-radius:50%; font-size:18px; cursor:pointer;">+</button>
                        </div>
                        <div id="giftCardsList" style="display:flex; flex-direction:column; gap:10px;"></div>
                    </div>
                </div>
            </div>

        </div> <!-- End App Container -->

        <!-- Bottom Nav -->
        <nav class="bottom-nav">
            <button class="nav-item active" onclick="switchView('home', this)">
                <span>ğŸ </span>
                ×‘×™×ª
            </button>
            <button class="nav-item" onclick="switchView('activity', this)">
                <span>ğŸ“„</span>
                ×¤×¢×™×œ×•×ª
            </button>
            <button class="nav-item" onclick="switchView('insights', this)">
                <span>ğŸ“Š</span>
                ×ª×•×‘× ×•×ª
            </button>
            <button class="nav-item" onclick="switchView('assets', this)">
                <span>ğŸ§§</span>
                × ×›×¡×™×
            </button>
        </nav>
    </div>

    <!-- Transaction Modal -->
    <div id="expModal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 id="expTitle">×”×•×¡×¤×ª ×”×•×¦××”</h3>
                <button onclick="closeModal()"
                    style="border:none; background:none; font-size:24px; color:var(--text-sub); cursor:pointer;">&times;</button>
            </div>

            <div style="display: flex; gap: 12px;">
                <div style="flex: 2;">
                    <label style="font-size:12px; color:var(--text-sub); margin-bottom:4px; display:block;">×¡×›×•×</label>
                    <input type="number" id="fAmt" placeholder="0.00" style="font-weight:700; font-size:18px;">
                </div>
                <div style="flex: 1;">
                    <label style="font-size:12px; color:var(--text-sub); margin-bottom:4px; display:block;">××˜×‘×¢</label>
                    <select id="fCurr" style="font-weight:600;">
                        <option value="ILS">â‚ª</option>
                        <option value="USD">$</option>
                        <option value="EUR">â‚¬</option>
                    </select>
                </div>
            </div>

            <label
                style="font-size:12px; color:var(--text-sub); margin-bottom:4px; display:block; margin-top:10px;">×ª×™××•×¨</label>
            <input type="text" id="expNote" placeholder="×¢×œ ××” ×™×¦× ×”×›×¡×£?">

            <label
                style="font-size:12px; color:var(--text-sub); margin-bottom:4px; display:block; margin-top:10px;">×××¦×¢×™
                ×ª×©×œ×•×</label>
            <label
                style="font-size:12px; color:var(--text-sub); margin-bottom:4px; display:block; margin-top:10px;">×××¦×¢×™
                ×ª×©×œ×•×</label>
            <select id="pMethod" onchange="toggleGiftCardSelect()">
                <option value="ğŸ’³ ××©×¨××™">ğŸ’³ ××©×¨××™</option>
                <option value="ğŸ’µ ××–×•××Ÿ">ğŸ’µ ××–×•××Ÿ</option>
                <option value="ğŸ“± ×‘×™×˜/×¤×™×™×‘×•×§×¡">ğŸ“± ×‘×™×˜/×¤×™×™×‘×•×§×¡</option>
                <option value="ğŸ¦ ×”×¢×‘×¨×”">ğŸ¦ ×”×¢×‘×¨×” ×‘× ×§××™×ª</option>
                <option value="ğŸ ×’×™×¤×˜ ×§××¨×“">ğŸ ×’×™×¤×˜ ×§××¨×“</option>
            </select>

            <div id="giftCardSelectDiv" style="display:none; margin-top:10px;">
                <label style="font-size:12px; color:var(--text-sub); margin-bottom:4px; display:block;">×‘×—×¨ ×›×¨×˜×™×¡
                    ×œ×—×™×•×‘</label>
                <select id="pGiftCardId"></select>
            </div>

            <div
                style="font-size:12px; color:var(--text-sub); margin-top:10px; background:var(--bg); padding:10px; border-radius:8px; border: 1px solid var(--input-border);">
                â„¹ï¸ ×”×¡×›×•× ×™×•××¨ ××•×˜×•××˜×™×ª ×œ×©×§×œ×™×.
                <br>
                <span id="rateInfo">××§×•×¨ ×©×¢×¨×™×: ×‘×¨×™×¨×ª ××—×“×œ (×§×‘×•×¢)</span>
            </div>

            <button class="btn-main" id="saveTxBtn">×©××™×¨×” ×•×¡×™×•×</button>
        </div>
    </div>

    <!-- Category Modal -->
    <div id="catModal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 id="catTitle">×§×˜×’×•×¨×™×” ×—×“×©×”</h3>
                <button onclick="document.getElementById('catModal').style.display='none'"
                    style="border:none; background:none; font-size:24px; color:var(--text-sub); cursor:pointer;">&times;</button>
            </div>

            <label style="font-size:12px; color:var(--text-sub); margin-bottom:4px; display:block;">×©× ×”×§×˜×’×•×¨×™×”</label>
            <input type="text" id="catName" placeholder="×œ××©×œ: ×¡×•×¤×¨, ×“×œ×§, ×‘×™×œ×•×™×™×">

            <label
                style="font-size:12px; color:var(--text-sub); margin-bottom:4px; display:block; margin-top:10px;">×ª×§×¦×™×‘
                ×—×•×“×©×™ (â‚ª)</label>
            <input type="number" id="catBudget" placeholder="0">

            <div style="display:flex; gap:10px; margin-top:15px;">
                <button class="btn-main" id="saveCatBtn" onclick="saveCategory()" style="margin-top:0;">×©××™×¨×”</button>
                <button id="delCatBtn" onclick="deleteCategory()"
                    style="background:none; border:none; color:var(--danger); font-weight:600; cursor:pointer; display:none;">××—×™×§×”</button>
            </div>
        </div>
    </div>

    <div id="recurringModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>×”×•×¨××•×ª ×§×‘×¢ ğŸ”„</h3>
                <span class="close-btn" onclick="closeModal('recurringModal')">&times;</span>
            </div>

            <div style="background:var(--bg); padding:15px; border-radius:12px; margin-bottom:20px;">
                <h4 style="margin:0 0 10px 0;">×”×•×¡×£ ×—×“×©</h4>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <input type="text" id="recName" placeholder="×©× (×œ××©×œ: × ×˜×¤×œ×™×§×¡)">
                    <input type="number" id="recAmount" placeholder="×¡×›×•×">
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <select id="recCat"></select>
                    <input type="date" id="recNextDate">
                </div>
                <button onclick="addRecurring()" class="btn-main" style="margin-top:10px;">×”×•×¡×¤×”</button>
            </div>

            <h4 style="margin-bottom:10px;">×¤×¢×™×œ×™×</h4>
            <div id="recurringList"
                style="display:flex; flex-direction:column; gap:10px; max-height:300px; overflow-y:auto;">
                <!-- List -->
            </div>
        </div>
    </div>

    <div id="incomeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>×”×•×¡×¤×ª ×”×›× ×¡×” ğŸ’°</h3>
                <span class="close-btn" onclick="closeModal('incomeModal')">&times;</span>
            </div>
            <label style="font-size:12px; color:var(--text-sub); margin-bottom:4px; display:block;">×¡×›×•×</label>
            <input type="number" id="incAmount" placeholder="0.00">

            <label
                style="font-size:12px; color:var(--text-sub); margin-bottom:4px; display:block; margin-top:10px;">××§×•×¨
                ×”×›× ×¡×”</label>
            <input type="text" id="incSource" placeholder="×œ××©×œ: ××©×›×•×¨×ª, ×‘×•× ×•×¡">

            <label
                style="font-size:12px; color:var(--text-sub); margin-bottom:4px; display:block; margin-top:10px;">×ª××¨×™×š</label>
            <input type="date" id="incDate">

            <button class="btn-main" onclick="saveIncome()">×©××™×¨×”</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, where, onSnapshot, addDoc, doc, deleteDoc, updateDoc, arrayUnion, Timestamp, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyB43p2CQBgAfhs1pDS9nVBM2o5Ty4-3aeU", authDomain: "expensetrackerpro-d216d.firebaseapp.com", projectId: "expensetrackerpro-d216d" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let user = null, cats = [], txs = [], savings = [], cards = [], chart = null;
        let income = [], barChart = null;
        let recurring = [];
        let editMode = { active: false, id: null };
        let catEditMode = { active: false, id: null };
        let rates = { ILS: 1, USD: 3.65, EUR: 3.95 }; // Initial Fallback

        async function fetchRates() {
            try {
                const res = await fetch('https://open.er-api.com/v6/latest/ILS');
                const data = await res.json();
                if (data && data.rates) {
                    // API returns 1 ILS = x USD. We need 1 USD = y ILS.
                    rates.USD = 1 / data.rates.USD;
                    rates.EUR = 1 / data.rates.EUR;
                    document.getElementById('rateInfo').innerText = `××§×•×¨ ×©×¢×¨×™×: ×—×™ (×¢×•×“×›×Ÿ ${new Date().toLocaleTimeString()})`;
                    document.getElementById('rateInfo').style.color = 'var(--success)';
                }
            } catch (e) {
                console.log("Failed to fetch rates", e);
            }
        }

        // Init
        fetchRates();

        // Theme Init
        if (localStorage.getItem('theme') === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
        }

        window.toggleTheme = () => {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const newTheme = isDark ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        };

        // --- NEW: Current Filter State ---
        let currentYearMonth = new Date().toISOString().slice(0, 7); // "YYYY-MM"

        // Set initial value for month picker
        document.getElementById('monthPicker').value = currentYearMonth;
        document.getElementById('monthPicker').addEventListener('change', (e) => {
            currentYearMonth = e.target.value;
            render(); // Re-render with new filter
        });

        window.openRecurring = () => {
            document.getElementById('recurringModal').style.display = 'flex';
            renderRecCats();
            renderRecurring();
        }

        function renderRecCats() {
            const sel = document.getElementById('recCat');
            sel.innerHTML = cats.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }

        window.addRecurring = async () => {
            const name = document.getElementById('recName').value;
            const amount = parseFloat(document.getElementById('recAmount').value);
            const catId = document.getElementById('recCat').value;
            const nextDate = document.getElementById('recNextDate').value;

            if (!name || isNaN(amount) || !nextDate) return showToast("×—×¡×¨×™× × ×ª×•× ×™×", 'error');

            try {
                await addDoc(collection(db, "recurring"), {
                    uid: user.uid,
                    name, amount, catId, nextDate, frequency: 'monthly'
                });
                showToast('×”×•×¨××ª ×§×‘×¢ × ×•×¡×¤×” ×‘×”×¦×œ×—×”', 'success');
                // Clear inputs
                document.getElementById('recName').value = '';
                document.getElementById('recAmount').value = '';
            } catch (e) {
                console.error(e);
                showToast('×©×’×™××” ×‘×”×•×¡×¤×”: ' + e.message, 'error');
            }
        };

        window.deleteRecurring = async (id) => {
            if (confirm('×œ××—×•×§ ×”×•×¨××ª ×§×‘×¢ ×–×•?')) {
                await deleteDoc(doc(db, "recurring", id)).catch(e => showToast("×©×’×™××” ×‘××—×™×§×”", 'error'));
            }
        };

        // --- Navigation ---
        window.switchView = (viewName, btn) => {
            // Hide all views
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            // Show selected
            document.getElementById(`view-${viewName}`).classList.add('active');

            // Update Nav
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if (btn) btn.classList.add('active');

            // If switching to Charts, we might need to resize/update
            if (viewName === 'insights') render();
        };

        function renderRecurring() {
            const el = document.getElementById('recurringList');
            el.innerHTML = recurring.map(r => {
                const cat = cats.find(c => c.id === r.catId);
                const [y, m, d] = r.nextDate.split('-');
                const fmtDate = `${d}/${m}/${y}`;
                return `
                <div class="cat-item" style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="font-weight:bold;">${r.name}</div>
                        <div style="font-size:12px; color:var(--text-sub);">
                            ${cat?.name || '?'} â€¢ â‚ª${r.amount}
                            <br> ×”×‘×: ${fmtDate}
                        </div>
                    </div>
                    <button onclick="deleteRecurring('${r.id}')" style="background:none; border:none; cursor:pointer;">ğŸ—‘ï¸</button>
                </div>`;
            }).join('');
        }

        async function checkRecurring() {
            const today = new Date().toISOString().slice(0, 10);

            for (const r of recurring) {
                if (r.nextDate <= today) {
                    // 1. Create Transaction
                    await addDoc(collection(db, "transactions"), {
                        allowedUsers: [user.email], // Use allowedUsers for transactions
                        amount: r.amount,
                        catId: r.catId,
                        note: `×”×•×¨××ª ×§×‘×¢: ${r.name}`,
                        date: Timestamp.fromDate(new Date(r.nextDate)), // Convert to Firebase Timestamp
                        method: '××©×¨××™', // Default to credit
                        currency: 'ILS'
                    });

                    // 2. Update Next Date (Add 1 Month)
                    const next = new Date(r.nextDate);
                    next.setMonth(next.getMonth() + 1);
                    await updateDoc(doc(db, "recurring", r.id), {
                        nextDate: next.toISOString().slice(0, 10)
                    });

                    console.log(`×”×•×¨××ª ×§×‘×¢ ×‘×•×¦×¢×”: ${r.name}`);
                }
            }
        }

        onAuthStateChanged(auth, u => {
            if (u) {
                user = u;
                document.getElementById('authScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                document.getElementById('userEmailDisplay').innerText = user.email.split('@')[0];
                document.getElementById('avatarLetter').innerText = user.email[0].toUpperCase();
                startSync();
            } else {
                document.getElementById('authScreen').style.display = 'flex';
                document.getElementById('mainApp').style.display = 'none';
            }
        });

        function startSync() {
            // Sync Categories
            onSnapshot(query(collection(db, "categories"), where("allowedUsers", "array-contains", user.email)), s => {
                cats = s.docs.map(d => ({ id: d.id, ...d.data() }));
                render();
            });

            // Sync Recurring
            onSnapshot(query(collection(db, "recurring"), where("uid", "==", user.uid)), s => {
                recurring = s.docs.map(d => ({ id: d.id, ...d.data() }));
                renderRecurring();
                checkRecurring();
            });

            // Sync Income
            onSnapshot(query(collection(db, "income"), where("uid", "==", user.uid), orderBy("date", "desc")), s => {
                income = s.docs.map(d => ({ id: d.id, ...d.data() }));
                renderIncome();
            });

            // Sync Transactions (Fetch ALL, filter locally for simplicity in this version)
            // Ideally we would query by date range, but that requires composite index setup which we can't do from here.
            onSnapshot(query(collection(db, "transactions"), where("allowedUsers", "array-contains", user.email), orderBy("date", "desc")), s => {
                txs = s.docs.map(d => {
                    const data = d.data();
                    // Convert Timestamp to js Date for easier filtering
                    return { id: d.id, ...data, jsDate: data.date.toDate() };
                });
                render();
            });

            // Sync Savings
            onSnapshot(query(collection(db, "savings"), where("owner", "==", user.email)), s => {
                savings = s.docs.map(d => ({ id: d.id, ...d.data() }));
                renderSavings();
            });

            // Sync Gift Cards
            onSnapshot(query(collection(db, "giftcards"), where("owner", "==", user.email)), s => {
                cards = s.docs.map(d => ({ id: d.id, ...d.data() }));
                renderGiftCards();
            });
        }

        function render() {
            // 1. Filter Transactions by Selected Month (For Budget/Stats)
            const filteredTxs = txs.filter(t => {
                const tDate = t.jsDate.toISOString().slice(0, 7); // "YYYY-MM"
                return tDate === currentYearMonth;
            });

            // 2. Handle Search Logic (For History List)
            const searchQuery = document.getElementById('searchInput')?.value.toLowerCase() || '';
            let displayTxs = filteredTxs; // Default to month view

            if (searchQuery) {
                // If searching, search EVERYTHING (ignore date filter)
                displayTxs = txs.filter(t => {
                    const catName = cats.find(c => c.id === t.catId)?.name.toLowerCase() || '';
                    return t.note.toLowerCase().includes(searchQuery) ||
                        catName.includes(searchQuery) ||
                        t.amount.toString().includes(searchQuery);
                });
            }

            // 3. Calculate Totals (Always based on Month)
            let totalBudget = 0;
            let totalSpent = 0;

            // Render Categories (Always based on Month)
            document.getElementById('catList').innerHTML = cats.map(c => {
                const catSpent = filteredTxs.filter(t => t.catId === c.id).reduce((s, t) => s + t.amount, 0);
                totalBudget += c.budget;
                totalSpent += catSpent;

                const perc = c.budget > 0 ? Math.min((catSpent / c.budget) * 100, 100) : 0;
                const color = perc >= 100 ? 'var(--danger)' : (perc >= 80 ? 'var(--warning)' : 'var(--success)');

                return `
                <div class="cat-item">
                    <div class="cat-header" onclick="openAddTx('${c.id}', '${c.name}')">
                        <div class="cat-name">
                            <span style="background:#EEF2FF; padding:8px; border-radius:8px; color:var(--primary)">ğŸ“‚</span>
                            ${c.name}
                        </div>
                        <div class="cat-stats">
                            <b style="color:var(--text-main)">â‚ª${Math.round(catSpent).toLocaleString()}</b>
                            <span style="color:var(--text-sub)"> / â‚ª${c.budget.toLocaleString()}</span>
                        </div>
                    </div>
                    
                    <div class="progress-bg">
                        <div class="progress-fill" style="width:${perc}%; background:${color}"></div>
                    </div>

                    <div class="cat-actions">
                        <div class="action-chip" onclick="openAddTx('${c.id}', '${c.name}')">â• ×”×•×¡×¤×”</div>
                        <div class="action-chip" onclick="shareCat('${c.id}')">ğŸ‘¥ ×©×™×ª×•×£</div>
                        <div class="action-chip" onclick="openEditCat('${c.id}', '${c.name}', ${c.budget})">âš™ï¸ ×”×’×“×¨×•×ª</div>
                    </div>
                </div>`;
            }).join('');

            // Update Summary Chips
            // Calculate Total Income for BALANCE
            // Note: Income is global list, need filtering by month? 
            // Let's filter income by same month for accurate "Monthly Balance"
            const monthlyIncome = income.filter(i => i.date.slice(0, 7) === currentYearMonth)
                .reduce((sum, i) => sum + i.amount, 0);

            // REAL Balance = (Monthly Income) - (Total Spent)
            // If no income logged, maybe fallback to (Budget - Spent)? 
            // User requested "Actual Income Tracking", so let's show Real Balance.
            // If monthlyIncome is 0, we can show (Budget - Spent) or just negative spent.
            // Let's settle on: Balance = Income - Spent.

            // Wait, "Budget" is "Planned". "Income" is "Actual".
            // Let's update chips:
            // Chip 1: Income (Actual)
            // Chip 2: Expenses
            // Chip 3: Balance (Income - Expenses)

            const elBudget = document.getElementById('totalBudgetDisplay');
            if (elBudget) {
                elBudget.innerText = 'â‚ª' + monthlyIncome.toLocaleString();
                if (elBudget.previousElementSibling) elBudget.previousElementSibling.innerText = "×”×›× ×¡×•×ª";
            }

            const elSpent = document.getElementById('totalSpentDisplay');
            if (elSpent) elSpent.innerText = 'â‚ª' + Math.round(totalSpent).toLocaleString();

            const elBal = document.getElementById('balanceDisplay');
            if (elBal) elBal.innerText = 'â‚ª' + Math.round(monthlyIncome - totalSpent).toLocaleString();

            // Render History (Based on separate displayTxs)
            const emptyMsg = searchQuery ? '×œ× × ××¦××• ×ª×•×¦××•×ª' : '××™×Ÿ × ×ª×•× ×™× ×œ×—×•×“×© ×–×”';
            document.getElementById('historyList').innerHTML = displayTxs.length ? displayTxs.map(t => {
                const sym = t.currency === 'USD' ? '$' : (t.currency === 'EUR' ? 'â‚¬' : 'â‚ª');
                const subText = t.currency !== 'ILS' ? `<span style="font-size:11px; color:gray">(${sym}${t.originalAmount})</span>` : '';
                return `
                <div class="history-item">
                    <div class="tx-info">
                        <div class="tx-note">${t.note} ${subText}</div>
                        <div class="tx-meta">
                            <span>${t.jsDate.toLocaleDateString('he-IL', { day: 'numeric', month: 'numeric' })}</span>
                            <span>â€¢</span>
                            <span>${t.method}</span>
                        </div>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div class="tx-amount">â‚ª${Math.round(t.amount).toLocaleString()}</div>
                        <div class="tx-actions">
                            <button title="×¢×¨×™×›×”" onclick="openEditTx('${t.id}')">âœï¸</button>
                            <button title="××—×™×§×”" onclick="deleteTx('${t.id}')" style="color:var(--danger)">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                </div>`;
            }).join('') : `<div style="text-align:center; padding:20px; color:var(--text-sub);">${emptyMsg}</div>`;


            // Re-adding Donut to Main Home View if needed? 
            // Actually, Plan said "Income vs Expenses" on Insights. 
            // Home view has "Expenses by Category" list which has progress bars.
            // Let's keep updateChart for the Insights Bar Chart.
            updateBarChart(monthlyIncome, totalSpent);
            updatePieChart(filteredTxs);
        }

        // --- Income Logic ---
        window.openAddIncome = () => {
            document.getElementById('incDate').value = new Date().toISOString().slice(0, 10);
            document.getElementById('incomeModal').style.display = 'flex';
        };

        window.saveIncome = async () => {
            const amount = parseFloat(document.getElementById('incAmount').value);
            const source = document.getElementById('incSource').value;
            const date = document.getElementById('incDate').value;

            if (!amount || !source || !date) return showToast("×—×¡×¨×™× × ×ª×•× ×™×", 'error');

            try {
                await addDoc(collection(db, "income"), {
                    uid: user.uid,
                    amount,
                    source,
                    date,
                    timestamp: new Date()
                });
                document.getElementById('incomeModal').style.display = 'none';
                document.getElementById('incAmount').value = '';
                document.getElementById('incSource').value = '';
                showToast('×”×›× ×¡×” × ×•×¡×¤×” ×‘×”×¦×œ×—×”', 'success');
            } catch (e) {
                console.error(e);
                showToast('×©×’×™××” ×‘×©××™×¨×”: ' + e.message, 'error');
                document.getElementById('incomeModal').style.display = 'none';
            }
        }

        window.deleteIncome = async (id) => {
            if (confirm('×œ××—×•×§ ×”×›× ×¡×” ×–×•?')) await deleteDoc(doc(db, "income", id));
        }

        function renderIncome() {
            // Filter by month
            const filtered = income.filter(i => i.date.slice(0, 7) === currentYearMonth);
            const total = filtered.reduce((s, i) => s + i.amount, 0);
            document.getElementById('totalIncomeDisplay').innerText = 'â‚ª' + total.toLocaleString();

            document.getElementById('incomeList').innerHTML = filtered.map(i => `
                <div style="display:flex; justify-content:space-between; padding:10px; background:var(--bg); border-radius:8px; align-items:center;">
                    <div>
                        <div style="font-weight:bold;">${i.source}</div>
                        <div style="font-size:12px; color:var(--text-sub);">${i.date}</div>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span style="color:var(--success); font-weight:bold;">+â‚ª${i.amount.toLocaleString()}</span>
                        <button onclick="deleteIncome('${i.id}')" style="border:none; background:none; cursor:pointer;">ğŸ—‘ï¸</button>
                    </div>
                </div>
             `).join('');

            // Trigger render to update chips/charts if this changes
            // render();
        }

        // Chart Logic (Bar Chart: Income vs Expense)
        function updateBarChart(incomeVal, expenseVal) {
            const ctx = document.getElementById('barChart')?.getContext('2d');
            if (!ctx) return;

            if (barChart) barChart.destroy();

            barChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['×”×›× ×¡×•×ª', '×”×•×¦××•×ª'],
                    datasets: [{
                        label: '×¡×›×•×',
                        data: [incomeVal, expenseVal],
                        backgroundColor: ['#10B981', '#EF4444'],
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // Chart Logic (Pie Chart: Expenses by Category)
        function updatePieChart(dataTxs) {
            const ctx = document.getElementById('pieChart')?.getContext('2d');
            if (!ctx) return;

            // Reuse chart instance if exists? Need global variable
            if (chart) chart.destroy();

            const data = cats.map(c => dataTxs.filter(t => t.catId === c.id).reduce((s, t) => s + t.amount, 0));
            const colors = ['#4F46E5', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899', '#06B6D4'];

            chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: cats.map(c => c.name),
                    datasets: [{
                        data,
                        backgroundColor: colors,
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { font: { family: 'Rubik' }, boxWidth: 10 } }
                    },
                    cutout: '70%'
                }
            });
        }

        // --- Actions ---
        window.openAddCat = () => {
            catEditMode = { active: false, id: null };
            document.getElementById('catTitle').innerText = "×§×˜×’×•×¨×™×” ×—×“×©×”";
            document.getElementById('catName').value = "";
            document.getElementById('catBudget').value = "";
            document.getElementById('delCatBtn').style.display = 'none'; // Hide delete btn
            document.getElementById('catModal').style.display = 'flex';
            document.getElementById('catName').focus();
        };

        window.openEditCat = (id, name, budget) => {
            catEditMode = { active: true, id: id };
            document.getElementById('catTitle').innerText = "×¢×¨×™×›×ª ×§×˜×’×•×¨×™×”";
            document.getElementById('catName').value = name;
            document.getElementById('catBudget').value = budget;
            document.getElementById('delCatBtn').style.display = 'block'; // Show delete btn
            document.getElementById('catModal').style.display = 'flex';
        };

        window.saveCategory = async () => {
            const name = document.getElementById('catName').value;
            const budget = parseFloat(document.getElementById('catBudget').value);

            if (!name || !budget) return showToast("× × ×œ××œ× ×©× ×•×ª×§×¦×™×‘", 'error');

            const data = { name: name, budget: budget };

            try {
                if (catEditMode.active) {
                    await updateDoc(doc(db, "categories", catEditMode.id), data);
                } else {
                    await addDoc(collection(db, "categories"), { ...data, owner: user.email, allowedUsers: [user.email] });
                }
                document.getElementById('catModal').style.display = 'none';
                showToast('×§×˜×’×•×¨×™×” × ×©××¨×” ×‘×”×¦×œ×—×”', 'success');
            } catch (e) {
                console.error(e);
                document.getElementById('catModal').style.display = 'none'; // Close modal even on error

                if (e.code === 'resource-exhausted') {
                    showToast('âš ï¸ ×”×’×¢×ª ×œ××›×¡×ª Firebase ×”×™×•××™×ª', 'error');
                } else {
                    showToast('âš ï¸ ×©×’×™××” ×‘×©××™×¨×”: ' + (e.message || '×œ× ×™×“×•×¢'), 'error');
                }
            }
        };

        window.deleteCategory = async () => {
            if (confirm("×œ××—×•×§ ××ª ×”×§×˜×’×•×¨×™×” ×”×–×•? (×”×”×•×¦××•×ª ×©×œ×” ×™×™×©××¨×• ××š ×œ×œ× ×©×™×•×š)")) {
                await deleteDoc(doc(db, "categories", catEditMode.id));
                document.getElementById('catModal').style.display = 'none';
            }
        };

        window.openEditTx = (id) => {
            const tx = txs.find(t => t.id === id);
            editMode = { active: true, id: id };
            window.currentCatId = tx.catId;
            document.getElementById('expTitle').innerText = "×¢×¨×™×›×ª ×”×•×¦××”";
            document.getElementById('fAmt').value = tx.originalAmount || tx.amount;
            document.getElementById('fCurr').value = tx.currency || "ILS";
            document.getElementById('expNote').value = tx.note;
            document.getElementById('pMethod').value = tx.method;
            document.getElementById('expModal').style.display = 'flex';
        };

        window.openAddTx = (id, name) => {
            editMode = { active: false, id: null };
            window.currentCatId = id;
            document.getElementById('expTitle').innerText = "×”×•×¦××” ×‘: " + name;
            document.getElementById('fAmt').value = "";
            document.getElementById('fCurr').value = "ILS";
            document.getElementById('expNote').value = "";
            document.getElementById('expModal').style.display = 'flex';
            document.getElementById('fAmt').focus();
        };

        window.closeModal = (id) => {
            if (id) {
                document.getElementById(id).style.display = 'none';
            } else {
                // Close all known modals if no specific ID provided
                ['expModal', 'catModal', 'recurringModal', 'incomeModal'].forEach(mid => {
                    const el = document.getElementById(mid);
                    if (el) el.style.display = 'none';
                });
            }
        };

        document.getElementById('saveTxBtn').onclick = async () => {
            const rawAmt = parseFloat(document.getElementById('fAmt').value);
            const curr = document.getElementById('fCurr').value;
            if (!rawAmt) return showToast("× × ×œ×”×–×™×Ÿ ×¡×›×•×", 'error');

            const converted = rawAmt * rates[curr];

            const data = {
                amount: converted,
                originalAmount: rawAmt,
                currency: curr,
                note: document.getElementById('expNote').value || "×”×•×¦××” ×›×œ×œ×™×ª",
                method: document.getElementById('pMethod').value,
                catId: window.currentCatId,
                allowedUsers: [user.email],
                // Use existing date if editing, or new date if new
                date: editMode.active ? txs.find(t => t.id === editMode.id).date : Timestamp.now()
            };

            try {
                if (editMode.active) await updateDoc(doc(db, "transactions", editMode.id), data);
                else await addDoc(collection(db, "transactions"), data);
                showToast('×”×•×¦××” × ×©××¨×” ×‘×”×¦×œ×—×”', 'success');
            } catch (e) {
                console.error(e);
                closeModal(); // Close modal immediately before showing error

                // User-friendly error messages
                if (e.code === 'resource-exhausted') {
                    showToast('âš ï¸ ×”×’×¢×ª ×œ××›×¡×ª Firebase ×”×™×•××™×ª', 'error');
                } else if (e.code === 'permission-denied') {
                    showToast('âš ï¸ ××™×Ÿ ×œ×š ×”×¨×©××” ×œ×‘×¦×¢ ×¤×¢×•×œ×” ×–×•', 'error');
                } else {
                    showToast('âš ï¸ ×©×’×™××” ×‘×©××™×¨×”: ' + (e.message || '×œ× ×™×“×•×¢'), 'error');
                }
            } finally {
                closeModal(); // ALWAYS close modal (double check)
            }
        };

        window.deleteTx = async (id) => { if (confirm("×œ××—×•×§ ××ª ×”×”×•×¦××” ×”×–×• ×œ×¦××™×ª×•×ª?")) await deleteDoc(doc(db, "transactions", id)).catch(e => showToast("×©×’×™××” ×‘××—×™×§×”", 'error')); };

        function renderSavings() {
            document.getElementById('savingsList').innerHTML = savings.length ? savings.map(s => {
                const perc = Math.min((s.current / s.target) * 100, 100);
                return `
                    <div style="padding:10px; background:#F9FAFB; border-radius:12px; border:1px solid #E5E7EB;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                            <span style="font-weight:600;">${s.name}</span>
                            <div style="font-size:12px;">â‚ª${s.current.toLocaleString()} / â‚ª${s.target.toLocaleString()}</div>
                        </div>
                        <div style="height:6px; background:#E5E7EB; border-radius:3px; overflow:hidden; margin-bottom:8px;">
                            <div style="height:100%; background:var(--success); width:${perc}%;"></div>
                        </div>
                        <div style="display:flex; justify-content:flex-end; gap:5px;">
                            <button onclick="depositSavings('${s.id}', ${s.current})" style="font-size:11px; padding:4px 8px; background:white; border:1px solid #E5E7EB; border-radius:6px; cursor:pointer;">ğŸ’° ×”×¤×§×“×”</button>
                            <button onclick="deleteSavings('${s.id}')" style="font-size:11px; padding:4px 8px; background:white; border:1px solid #E5E7EB; border-radius:6px; cursor:pointer; color:var(--danger)">ğŸ—‘ï¸</button>
                        </div>
                    </div>`;
            }).join('') : '<div style="text-align:center; color:gray; font-size:12px;">××™×Ÿ ×™×¢×“×™× ×¢×“×™×™×Ÿ</div>';
        }

        function renderGiftCards() {
            const list = document.getElementById('giftCardsList');
            const select = document.getElementById('pGiftCardId');

            // UI List
            list.innerHTML = cards.length ? cards.map(c => `
                <div style="display:flex; justify-content:space-between; align-items:center; adding:10px; background:#F0FDFA; border:1px solid #CCFBF1; border-radius:10px; padding:10px;">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <span style="font-size:20px;">ğŸ</span>
                        <div>
                            <div style="font-weight:600; font-size:14px;">${c.name}</div>
                            <div style="font-size:12px; color:#0D9488;">â‚ª${c.current.toLocaleString()} × ×•×ª×¨</div>
                        </div>
                    </div>
                    <button onclick="deleteGiftCard('${c.id}')" style="background:none; border:none; color:var(--danger); cursor:pointer;">&times;</button>
                </div>
            `).join('') : '<div style="text-align:center; color:gray; font-size:12px;">××™×Ÿ ×›×¨×˜×™×¡×™×</div>';

            // Select Options
            select.innerHTML = cards.map(c => `<option value="${c.id}">${c.name} (â‚ª${c.current})</option>`).join('');
        }

        window.toggleGiftCardSelect = () => {
            const val = document.getElementById('pMethod').value;
            document.getElementById('giftCardSelectDiv').style.display = val === 'ğŸ ×’×™×¤×˜ ×§××¨×“' ? 'block' : 'none';
        };

        window.addGiftCard = async () => {
            const n = prompt("×©× ×”×›×¨×˜×™×¡ (×œ××©×œ: BuyMe):");
            if (!n) return;
            const b = prompt("×¡×›×•× ×”×ª×—×œ×ª×™:");
            if (n && b) {
                addDoc(collection(db, "giftcards"), { name: n, initial: parseFloat(b), current: parseFloat(b), owner: user.email })
                    .then(() => showToast('×›×¨×˜×™×¡ ××ª× ×” × ×•×¡×£', 'success'))
                    .catch(e => showToast("×©×’×™××”: " + e.message, 'error'));
            }
        };

        window.deleteGiftCard = async (id) => { if (confirm("×œ××—×•×§ ×›×¨×˜×™×¡ ×–×”?")) await deleteDoc(doc(db, "giftcards", id)).catch(e => showToast("×©×’×™××” ×‘××—×™×§×”", 'error')); };

        window.addSavingsGoal = async () => {
            const n = prompt("×©× ×”×™×¢×“ (×œ××©×œ: ×—×•×¤×©×” ×‘×™×•×•×Ÿ):");
            if (!n) return;
            const t = prompt("×¡×›×•× ×”×™×¢×“:");
            if (n && t) {
                addDoc(collection(db, "savings"), { name: n, target: parseFloat(t), current: 0, owner: user.email })
                    .then(() => showToast('×™×¢×“ ×—×™×¡×›×•×Ÿ × ×•×¡×£', 'success'))
                    .catch(e => showToast("×©×’×™××”: " + e.message, 'error'));
            }
        };

        window.depositSavings = async (id, current) => {
            const amount = prompt("×›××” ×œ×”×¤×§×™×“ ×œ×™×¢×“ ×–×”?");
            if (amount) {
                updateDoc(doc(db, "savings", id), { current: current + parseFloat(amount) })
                    .then(() => showToast('×”×¤×§×“×” ×‘×•×¦×¢×”!', 'success'))
                    .catch(e => showToast("×©×’×™××” ×‘×”×¤×§×“×”", 'error'));
            }
        };

        window.deleteSavings = async (id) => { if (confirm("×œ××—×•×§ ××ª ×”×™×¢×“ ×”×–×”?")) await deleteDoc(doc(db, "savings", id)).catch(e => showToast("×©×’×™××” ×‘××—×™×§×”", 'error')); };

        window.shareCat = async (id) => {
            const email = prompt("×”×›× ×¡ ××ª ×”××™××™×™×œ ×©×œ ×”××©×ª××© ××™×ª×• ×ª×¨×¦×” ×œ×©×ª×£ ××ª ×”×§×˜×’×•×¨×™×”:");
            if (email) {
                updateDoc(doc(db, "categories", id), { allowedUsers: arrayUnion(email) })
                    .then(() => showToast(`×©×•×ª×£ ×‘×”×¦×œ×—×” ×¢× ${email}`, 'success'))
                    .catch(e => showToast("×©×’×™××” ×‘×©×™×ª×•×£ " + e.message, 'error'));
            }
        };

        window.exportToCSV = () => {
            let csvContent = "\uFEFF"; // BOM for Hebrew support
            csvContent += "Date,Amount,Currency,Category,Note,Method\n";

            txs.forEach(t => {
                const date = t.jsDate.toLocaleDateString('en-CA'); // YYYY-MM-DD
                const catName = cats.find(c => c.id === t.catId)?.name || 'Unknown';
                const row = [
                    date,
                    t.originalAmount || t.amount,
                    t.currency || 'ILS',
                    `"${catName.replace(/"/g, '""')}"`,
                    `"${t.note.replace(/"/g, '""')}"`,
                    t.method
                ].join(",");
                csvContent += row + "\n";
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `budget_export_${new Date().toISOString().slice(0, 10)}.csv`;
            link.click();
        };

        document.getElementById('loginBtn').onclick = () => signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value).catch(e => showToast("×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª: " + e.message, 'error'));
        document.getElementById('signupBtn').onclick = () => createUserWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value).catch(e => showToast("×©×’×™××” ×‘×”×¨×©××”: " + e.message, 'error'));
        window.logout = () => {
            signOut(auth).then(() => showToast('×”×ª× ×ª×§×ª ×‘×”×¦×œ×—×”', 'success'));
        };

        // NUCLEAR OPTION: Force close backup
        // This runs independently of the main logic to guarantee closure
        const safeSaveBtn = document.getElementById('saveTxBtn');
        if (safeSaveBtn) {
            safeSaveBtn.addEventListener('click', () => {
                setTimeout(() => {
                    closeModal();
                }, 500);
            });
        }
    </script>
</body>

</html>